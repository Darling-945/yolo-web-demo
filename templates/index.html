{% extends 'base.html' %}

{% block content %}
<div class="main-container fade-in">
  <!-- 标题区域 -->
  <header class="text-center mb-5 mb-lg-6">
    <i class="fas fa-eye fa-4x fa-lg-5x mb-4 float-animation" style="color: var(--primary-color);"></i>
    <h1 class="display-4 fw-bold mb-3">智能目标检测</h1>
    <p class="lead text-muted fs-5 d-none d-lg-block">上传图片，使用先进的YOLO技术检测目标</p>
    <p class="text-muted fs-6 d-lg-none">上传图片进行目标检测</p>
  </header>

  <!-- 上传区域 -->
  <section class="upload-section mb-5 mb-lg-6">
    <form action="/infer" method="POST" enctype="multipart/form-data" id="uploadForm" class="text-center">
      <!-- 上传框 -->
      <div class="upload-area mx-auto mb-4" id="uploadArea"
           role="button"
           tabindex="0"
           aria-label="图片上传区域，可以拖拽或点击选择图片文件"
           aria-describedby="upload-help">
        <i class="fas fa-cloud-upload-alt fa-3x mb-4" style="color: var(--primary-color);" aria-hidden="true"></i>
        <h4 class="fw-semibold mb-3">拖拽图片或视频到此处</h4>
        <p class="text-muted mb-4">或</p>
        <input type="file"
               name="files"
               accept=".jpg, .jpeg, .png, .webp, .bmp, .gif, .tiff, .tif, .mp4, .avi, .mov, .mkv, .wmv, .flv, .webm, .m4v"
               class="form-control"
               id="fileInput"
               multiple
               aria-label="选择图片或视频文件"
               style="display: none;">
        <button type="button"
                class="btn btn-outline-primary px-5 py-3"
                id="selectFileBtn"
                style="cursor: pointer; margin: 0;">
          <i class="fas fa-folder-open me-2"></i>点击选择文件
        </button>
        <p class="text-muted mt-4 mb-0" id="upload-help">
          支持图片格式：JPG, JPEG, PNG, WEBP, BMP, GIF, TIFF<br>
          支持视频格式：MP4, AVI, MOV, MKV, WMV, FLV, WEBM, M4V<br>
          图片最大 16MB，视频最大 500MB
        </p>
      </div>

      <!-- 预览区域 -->
      <div id="previewContainer" class="preview-section mb-4" style="display: none;">
        <h5 class="fw-semibold mb-3">
          <span id="previewTitle">文件预览</span>
          <span id="fileCount" class="badge bg-primary ms-2"></span>
        </h5>
        <div id="previewGrid" class="row g-3">
          <!-- 单个预览将动态添加到这里 -->
        </div>
        <!-- 单个预览图片作为后备 -->
        <img id="previewImage" class="img-fluid rounded-3 shadow-lg d-none" style="max-height: 200px; border: 3px solid var(--primary-color);">
      </div>

      <!-- 配置区域 -->
      <div class="config-section card mx-auto mb-4" style="max-width: 800px;">
        <div class="card-body p-4">
          <h5 class="card-title text-center mb-4 fw-semibold">
            <i class="fas fa-cog me-2"></i>检测配置
          </h5>
          <div class="row g-4 justify-content-center align-items-start">
            <!-- 模型选择 -->
            <div class="col-12">
              <div class="text-center">
                <label for="modelSelect" class="form-label fw-semibold d-block mb-3">
                  <i class="fas fa-robot me-2"></i>选择模型
                </label>
                <select class="form-select mx-auto" id="modelSelect" name="model" style="max-width: 450px;">
                  <optgroup label="YOLOv11 系列 (PyTorch)">
                    <option value="yolo11n.pt">YOLOv11 Nano (最快)</option>
                    <option value="yolo11s.pt">YOLOv11 Small</option>
                    <option value="yolo11m.pt">YOLOv11 Medium</option>
                    <option value="yolo11l.pt">YOLOv11 Large</option>
                    <option value="yolo11x.pt">YOLOv11 Extra Large (最准确)</option>
                  </optgroup>
                  <optgroup label="YOLOv8 系列 (PyTorch)">
                    <option value="yolov8n.pt">YOLOv8 Nano</option>
                    <option value="yolov8s.pt">YOLOv8 Small</option>
                    <option value="yolov8m.pt">YOLOv8 Medium</option>
                    <option value="yolov8l.pt">YOLOv8 Large</option>
                    <option value="yolov8x.pt">YOLOv8 Extra Large</option>
                  </optgroup>
                  <optgroup label="YOLOv5 系列 (PyTorch)">
                    <option value="yolov5n.pt">YOLOv5 Nano</option>
                    <option value="yolov5s.pt">YOLOv5 Small</option>
                    <option value="yolov5m.pt">YOLOv5 Medium</option>
                    <option value="yolov5l.pt">YOLOv5 Large</option>
                    <option value="yolov5x.pt">YOLOv5 Extra Large</option>
                  </optgroup>
                  <optgroup label="自定义 PyTorch 模型" id="customPyTorchModelsGroup" style="display: none;">
                    <!-- 自定义 PyTorch 模型将通过JavaScript动态添加 -->
                  </optgroup>
                  <optgroup label="自定义 ONNX 模型" id="customONNXModelsGroup" style="display: none;">
                    <!-- 自定义 ONNX 模型将通过JavaScript动态添加 -->
                  </optgroup>
                  <optgroup label="自定义 TensorRT 模型" id="customTensorRTModelsGroup" style="display: none;">
                    <!-- 自定义 TensorRT 模型将通过JavaScript动态添加 -->
                  </optgroup>
                </select>
              </div>
            </div>

            <!-- 参数调节 -->
            <div class="col-12 col-lg-6">
              <div class="text-center">
                <label for="confidenceSlider" class="form-label fw-semibold d-block mb-3">
                  <i class="fas fa-bullseye me-2"></i>置信度阈值
                </label>
                <div class="d-flex flex-column align-items-center gap-3">
                  <input type="range" class="form-range" style="max-width: 250px;" id="confidenceSlider" min="0.1" max="0.9" step="0.05" value="0.25">
                  <div class="d-flex align-items-center gap-3">
                    <input type="number" class="form-control text-center" id="confidenceInput" min="0.1" max="0.9" step="0.05" value="0.25" style="width: 100px;">
                    <span class="badge bg-primary px-3 py-2 fs-6" id="confidenceValue">0.25</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="text-center">
                <label for="iouSlider" class="form-label fw-semibold d-block mb-3">
                  <i class="fas fa-vector-square me-2"></i>IOU阈值
                </label>
                <div class="d-flex flex-column align-items-center gap-3">
                  <input type="range" class="form-range" style="max-width: 250px;" id="iouSlider" min="0.1" max="0.9" step="0.05" value="0.45">
                  <div class="d-flex align-items-center gap-3">
                    <input type="number" class="form-control text-center" id="iouInput" min="0.1" max="0.9" step="0.05" value="0.45" style="width: 100px;">
                    <span class="badge bg-success px-3 py-2 fs-6" id="iouValue">0.45</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 检测按钮 -->
      <div class="submit-section text-center">
        <button type="submit" class="btn btn-primary btn-lg px-6 py-3 position-relative" id="uploadBtn" disabled style="min-width: 200px;">
          <span id="uploadBtnText">
            <i class="fas fa-search me-2"></i>开始检测
          </span>
          <div class="loading-spinner ms-2" id="uploadSpinner"></div>
          <div class="ripple-effect"></div>
        </button>

        <!-- 进度条 -->
        <div class="progress-container mt-4" id="progressContainer" style="display: none;">
          <div class="modern-progress mx-auto" style="max-width: 400px;">
            <div class="modern-progress-bar" id="progressBar" style="width: 0%"></div>
          </div>
          <div class="text-center mt-3">
            <small class="text-muted" id="progressText">正在上传图片...</small>
          </div>
        </div>
      </div>
    </form>
  </section>

  <!-- 特性展示 - 横向布局 -->
  <section class="features-section">
    <div class="text-center mb-5">
      <h3 class="fw-bold mb-3">核心特性</h3>
      <p class="text-muted fs-5">体验先进的目标检测技术</p>
    </div>
    <div class="row justify-content-center g-4 align-items-stretch">
      <div class="col-6 col-md-4 col-lg-2">
        <div class="feature-item h-100">
          <div class="feature-icon mx-auto mb-3">
            <i class="fas fa-bolt"></i>
          </div>
          <h6 class="fw-semibold mb-2">实时检测</h6>
          <p class="text-muted small mb-0">基于YOLO算法的快速准确目标检测</p>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="feature-item h-100">
          <div class="feature-icon mx-auto mb-3">
            <i class="fas fa-cogs"></i>
          </div>
          <h6 class="fw-semibold mb-2">多模型支持</h6>
          <p class="text-muted small mb-0">支持YOLOv5/v8/v11及自定义模型</p>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="feature-item h-100">
          <div class="feature-icon mx-auto mb-3">
            <i class="fas fa-sliders-h"></i>
          </div>
          <h6 class="fw-semibold mb-2">灵活配置</h6>
          <p class="text-muted small mb-0">可调节置信度阈值和模型选择</p>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="feature-item h-100">
          <div class="feature-icon mx-auto mb-3">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h6 class="fw-semibold mb-2">安全可靠</h6>
          <p class="text-muted small mb-0">本地处理，保护数据隐私</p>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="feature-item h-100">
          <div class="feature-icon mx-auto mb-3">
            <i class="fas fa-palette"></i>
          </div>
          <h6 class="fw-semibold mb-2">可视化输出</h6>
          <p class="text-muted small mb-0">直观的检测框和置信度显示</p>
        </div>
      </div>
      <div class="col-6 col-md-4 col-lg-2">
        <div class="feature-item h-100">
          <div class="feature-icon mx-auto mb-3">
            <i class="fas fa-download"></i>
          </div>
          <h6 class="fw-semibold mb-2">结果导出</h6>
          <p class="text-muted small mb-0">支持下载和分享检测结果</p>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
// 页面加载时获取自定义模型
document.addEventListener('DOMContentLoaded', function() {
    loadCustomModels();

    // 卡片动画
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in');
    });
});

// 加载自定义模型
async function loadCustomModels() {
    try {
        const response = await fetch('/api/models');
        const data = await response.json();

        // 处理自定义 PyTorch 模型
        if (data.custom_models && data.custom_models.pytorch && data.custom_models.pytorch.length > 0) {
            const customPyTorchGroup = document.getElementById('customPyTorchModelsGroup');
            customPyTorchGroup.style.display = 'block';
            customPyTorchGroup.innerHTML = '';

            data.custom_models.pytorch.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model.replace('.pt', '') + ' (自定义 PyTorch)';
                customPyTorchGroup.appendChild(option);
            });
        }

        // 处理自定义 ONNX 模型
        if (data.custom_models && data.custom_models.onnx && data.custom_models.onnx.length > 0) {
            const customONNXGroup = document.getElementById('customONNXModelsGroup');
            customONNXGroup.style.display = 'block';
            customONNXGroup.innerHTML = '';

            data.custom_models.onnx.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model.replace('.onnx', '') + ' (自定义 ONNX)';
                option.setAttribute('data-format', 'onnx');
                customONNXGroup.appendChild(option);
            });
        }

        // 处理自定义 TensorRT 模型
        if (data.custom_models && data.custom_models.tensorrt && data.custom_models.tensorrt.length > 0) {
            const customTensorRTGroup = document.getElementById('customTensorRTModelsGroup');
            customTensorRTGroup.style.display = 'block';
            customTensorRTGroup.innerHTML = '';

            data.custom_models.tensorrt.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model.replace('.engine', '') + ' (自定义 TensorRT)';
                option.setAttribute('data-format', 'tensorrt');
                customTensorRTGroup.appendChild(option);
            });
        }

        // 显示支持的格式信息
        if (data.supported_formats) {
            console.log('支持的模型格式:', data.supported_formats.join(', '));
        }
    } catch (error) {
        console.log('无法加载自定义模型:', error);
    }
}

// 文件输入处理 (已移动到页面加载事件中)

// 置信度双模式处理
function setupConfidenceControls() {
    const slider = document.getElementById('confidenceSlider');
    const input = document.getElementById('confidenceInput');
    const badge = document.getElementById('confidenceValue');

    // 滑块变化时更新输入框和标签
    slider.addEventListener('input', function(e) {
        const value = parseFloat(e.target.value);
        input.value = value;
        badge.textContent = value;
    });

    // 输入框变化时更新滑块和标签
    input.addEventListener('input', function(e) {
        let value = parseFloat(e.target.value);

        // 验证输入值范围
        if (isNaN(value)) value = 0.25;
        if (value < 0.1) value = 0.1;
        if (value > 0.9) value = 0.9;

        // 四舍五入到步长的精度
        value = Math.round(value / 0.05) * 0.05;

        input.value = value;
        slider.value = value;
        badge.textContent = value;
    });

    // 输入框失去焦点时验证格式
    input.addEventListener('blur', function(e) {
        let value = parseFloat(e.target.value);
        if (isNaN(value) || value < 0.1 || value > 0.9) {
            value = 0.25;
            input.value = value;
            slider.value = value;
            badge.textContent = value;
        }
    });
}

// IOU双模式处理
function setupIOUControls() {
    const slider = document.getElementById('iouSlider');
    const input = document.getElementById('iouInput');
    const badge = document.getElementById('iouValue');

    // 滑块变化时更新输入框和标签
    slider.addEventListener('input', function(e) {
        const value = parseFloat(e.target.value);
        input.value = value;
        badge.textContent = value;
    });

    // 输入框变化时更新滑块和标签
    input.addEventListener('input', function(e) {
        let value = parseFloat(e.target.value);

        // 验证输入值范围
        if (isNaN(value)) value = 0.45;
        if (value < 0.1) value = 0.1;
        if (value > 0.9) value = 0.9;

        // 四舍五入到步长的精度
        value = Math.round(value / 0.05) * 0.05;

        input.value = value;
        slider.value = value;
        badge.textContent = value;
    });

    // 输入框失去焦点时验证格式
    input.addEventListener('blur', function(e) {
        let value = parseFloat(e.target.value);
        if (isNaN(value) || value < 0.1 || value > 0.9) {
            value = 0.45;
            input.value = value;
            slider.value = value;
            badge.textContent = value;
        }
    });
}

// 初始化控件
document.addEventListener('DOMContentLoaded', function() {
    setupConfidenceControls();
    setupIOUControls();
});

// 表单提交处理
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    console.log('表单提交开始');
    // 不阻止默认提交，让表单正常提交

    const uploadBtn = document.getElementById('uploadBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const uploadSpinner = document.getElementById('uploadSpinner');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // 验证是否有文件
    const fileInput = document.getElementById('fileInput');
    if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        showToast('error', '请先选择要上传的图片', 'error');
        return;
    }

    console.log('开始上传文件:', fileInput.files[0].name);

    // 显示加载状态
    if (uploadBtn) uploadBtn.disabled = true;
    if (uploadBtnText) uploadBtnText.style.display = 'none';
    if (uploadSpinner) uploadSpinner.style.display = 'inline-block';
    if (progressContainer) progressContainer.style.display = 'block';

    // 添加波纹效果
    createRipple(e);

    // 显示Toast通知
    showToast('info', '正在上传图片并进行检测...', 'info');

    // 模拟进度条动画
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;

        if (progressBar) progressBar.style.width = progress + '%';

        if (progress < 30) {
            if (progressText) progressText.textContent = '正在上传图片...';
        } else if (progress < 60) {
            if (progressText) progressText.textContent = '正在加载模型...';
        } else if (progress < 90) {
            if (progressText) progressText.textContent = '正在进行目标检测...';
        }
    }, 200);

    // 获取配置参数
    const modelSelect = document.getElementById('modelSelect');
    const confidenceInput = document.getElementById('confidenceInput');
    const iouInput = document.getElementById('iouInput');

    const model = modelSelect ? modelSelect.value : 'yolo11n.pt';
    const confidence = confidenceInput ? confidenceInput.value : '0.25';
    const iou = iouInput ? iouInput.value : '0.45';

    console.log('配置参数:', { model, confidence, iou });

    // 创建隐藏输入字段 - 先清理旧的
    const existingHidden = this.querySelectorAll('input[type="hidden"]');
    existingHidden.forEach(input => input.remove());

    // 创建新的隐藏输入字段
    const modelHidden = document.createElement('input');
    modelHidden.type = 'hidden';
    modelHidden.name = 'model';
    modelHidden.value = model;
    this.appendChild(modelHidden);

    const confidenceHidden = document.createElement('input');
    confidenceHidden.type = 'hidden';
    confidenceHidden.name = 'confidence';
    confidenceHidden.value = confidence;
    this.appendChild(confidenceHidden);

    const iouHidden = document.createElement('input');
    iouHidden.type = 'hidden';
    iouHidden.name = 'iou';
    iouHidden.value = iou;
    this.appendChild(iouHidden);

    console.log('隐藏字段已添加，准备提交表单');

    // 创建FormData对象
    const formData = new FormData(this);
    console.log('表单验证完成，准备提交');

    // 使用传统表单提交方式
    // 移除preventDefault以允许正常表单提交
    setTimeout(() => {
        this.submit(); // 使用原生表单提交
    }, 100);

    // 设置超时，防止进度条无限运行
    setTimeout(() => {
        clearInterval(progressInterval);
        if (progressBar) progressBar.style.width = '100%';
        if (progressText) progressText.textContent = '处理中...';
    }, 10000); // 增加超时时间到10秒
});

// 创建波纹效果
function createRipple(e) {
    const button = e.currentTarget;
    const ripple = document.createElement('span');
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = e.clientX - rect.left - size / 2;
    const y = e.clientY - rect.top - size / 2;

    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    ripple.classList.add('ripple-effect');

    button.appendChild(ripple);

    setTimeout(() => {
        ripple.remove();
    }, 600);
}

// 为按钮添加波纹效果
const uploadBtn = document.getElementById('uploadBtn');
if (uploadBtn) {
    uploadBtn.addEventListener('click', createRipple);
}

// 处理拖拽文件
function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();

    const dt = e.dataTransfer;
    const files = dt.files;

    // 验证拖拽的文件
    if (files.length === 0) {
        showToast('error', '没有检测到文件', 'error');
        return;
    }

    const file = files[0];

    // 处理文件
    if (handleFile(file)) {
        // 设置文件输入框的值（保留用于表单提交）
        const fileInput = document.getElementById('fileInput');

        // 创建新的DataTransfer对象来设置文件
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        // 显示成功提示
        showToast('success', `已添加文件: ${file.name}`, 'success');
    }
}

// 键盘快捷键支持
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter 快速上传
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn && !uploadBtn.disabled) {
            e.preventDefault();
            console.log('⌨️ Ctrl+Enter 触发上传');
            uploadBtn.form?.dispatchEvent(new Event('submit'));
        }
    }

    // Ctrl+O 打开文件选择
    if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
        e.preventDefault();
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            console.log('⌨️ Ctrl+O 打开文件选择');
            fileInput.click();
        }
    }
});

// 文件处理函数（用于拖拽上传）
function handleFile(file) {
    console.log('开始处理文件:', file ? file.name : 'null');

    if (!file) {
        console.error('文件为空');
        showToast('error', '没有选择文件', 'error');
        return false;
    }

    console.log('文件信息:', {
        name: file.name,
        type: file.type,
        size: file.size
    });

    // 验证文件类型 - 支持图片和视频
    const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/bmp', 'image/gif'];
    const videoTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo', 'video/x-matroska'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.webp', '.bmp', '.gif', '.tiff', '.tif'];
    const videoExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v'];

    const allTypes = [...imageTypes, ...videoTypes];
    const allExtensions = [...imageExtensions, ...videoExtensions];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));

    if (!allTypes.includes(file.type) && !allExtensions.includes(fileExtension)) {
        console.error('不支持的文件类型:', file.type, '扩展名:', fileExtension);
        showToast('error', `不支持的文件类型 (${file.type || fileExtension})，请选择图片或视频文件`, 'error');
        return false;
    }

    // 验证文件大小 - 根据文件类型设置不同限制
    const isVideo = videoTypes.includes(file.type) || videoExtensions.includes(fileExtension);
    const maxSize = isVideo ? 500 * 1024 * 1024 : 50 * 1024 * 1024; // 视频500MB，图片50MB
    if (file.size > maxSize) {
        console.error('文件过大:', file.size, '最大允许:', maxSize);
        const maxSizeMB = maxSize / (1024 * 1024);
        showToast('error', `文件大小不能超过 ${maxSizeMB}MB，当前文件大小: ${(file.size / 1024 / 1024).toFixed(2)}MB`, 'error');
        return false;
    }

    // 启用上传按钮
    const uploadBtn = document.getElementById('uploadBtn');
    if (uploadBtn) {
        uploadBtn.disabled = false;
        console.log('上传按钮已启用');
    } else {
        console.error('找不到上传按钮');
    }

    // 显示预览
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const previewImg = document.getElementById('previewImage');
            const previewContainer = document.getElementById('previewContainer');

            if (previewImg && previewContainer) {
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';
                previewContainer.classList.add('fade-in');
                console.log('图片预览已显示');
                showToast('success', `图片已成功加载: ${file.name}`, 'success');
            } else {
                console.error('找不到预览元素');
                showToast('error', '预览显示失败', 'error');
            }
        } catch (error) {
            console.error('显示预览时出错:', error);
            showToast('error', '预览显示失败', 'error');
        }
    };

    reader.onerror = function(error) {
        console.error('读取文件失败:', error);
        showToast('error', '文件读取失败', 'error');
    };

    reader.readAsDataURL(file);
    console.log('开始读取文件数据');

    return true;
}

// 页面加载完成后添加增强功能
document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，初始化事件监听器...');

    // 获取DOM元素
    const fileInput = document.getElementById('fileInput');
    const selectBtn = document.getElementById('selectFileBtn');
    const uploadArea = document.getElementById('uploadArea');
    const modelSelect = document.getElementById('modelSelect');

    // 调试信息：检查关键元素是否存在
    console.log('DOM元素检查结果:');
    console.log('- fileInput:', fileInput ? '✅ 找到' : '❌ 未找到');
    console.log('- selectBtn:', selectBtn ? '✅ 找到' : '❌ 未找到');
    console.log('- uploadArea:', uploadArea ? '✅ 找到' : '❌ 未找到');
    console.log('- modelSelect:', modelSelect ? '✅ 找到' : '❌ 未找到');

    // 初始化拖拽功能
    if (uploadArea && fileInput) {
        initDragAndDrop();
    }

    // 文件输入框初始化
    if (fileInput) {
        fileInput.setAttribute('title', '支持 JPG、PNG、WEBP 格式，最大 16MB');
        console.log('✅ 文件输入框初始化完成');
    } else {
        console.error('❌ 找不到文件输入框');
    }

    // 模型选择事件
    if (modelSelect) {
        modelSelect.addEventListener('change', function(e) {
            const modelText = e.target.options[e.target.selectedIndex].text;
            showToast('info', `已选择模型: ${modelText}`, 'info');
        });
        console.log('模型选择器初始化完成');
    } else {
        console.error('找不到模型选择器');
    }

    // 文件上传处理 - 使用按钮点击触发文件选择
    if (fileInput) {
        console.log('✅ 文件输入框初始化完成');

        // 为选择文件按钮添加点击事件
        const selectFileBtn = document.getElementById('selectFileBtn');
        if (selectFileBtn) {
            // 移除可能存在的旧事件监听器
            selectFileBtn.removeEventListener('click', handleSelectFileClick);

            // 添加新的事件监听器
            selectFileBtn.addEventListener('click', handleSelectFileClick);
            console.log('✅ 选择文件按钮点击事件初始化完成');
        } else {
            console.error('❌ 找不到选择文件按钮');
        }

        // 文件选择点击处理函数
        function handleSelectFileClick(e) {
            e.preventDefault();
            e.stopPropagation(); // 防止事件冒泡到上传区域
            console.log('选择文件按钮被点击');

            // 检查文件输入框是否存在
            if (!fileInput) {
                console.error('文件输入框不存在');
                showToast('error', '文件输入组件初始化失败', 'error');
                return;
            }

            try {
                console.log('准备打开文件选择对话框');

                // 直接点击文件输入框
                fileInput.click();
                console.log('文件选择对话框已打开');

            } catch (error) {
                console.error('打开文件选择对话框失败:', error);
                showToast('error', '无法打开文件选择对话框', 'error');
            }
        }

        // 为整个上传区域添加点击事件（排除按钮区域和配置区域）
        if (uploadArea) {
            uploadArea.addEventListener('click', function(e) {
                // 如果点击的是选择文件按钮、配置区域或其他交互元素，则不触发文件选择
                if (e.target.closest('#selectFileBtn') ||
                    e.target.closest('.config-section') ||
                    e.target.closest('button') ||
                    e.target.closest('select') ||
                    e.target.closest('input') ||
                    e.target.tagName === 'BUTTON' ||
                    e.target.tagName === 'SELECT' ||
                    e.target.tagName === 'INPUT') {
                    return;
                }

                e.preventDefault();
                e.stopPropagation(); // 防止事件冒泡
                console.log('上传区域被点击（非按钮区域）');
                try {
                    fileInput.click();
                } catch (error) {
                    console.error('打开文件选择对话框失败:', error);
                    showToast('error', '无法打开文件选择对话框', 'error');
                }
            });
            console.log('✅ 上传区域点击事件初始化完成');
        } else {
            console.error('❌ 找不到上传区域');
        }

        // 文件输入变化事件
        fileInput.addEventListener('change', function(e) {
            console.log('文件输入发生变化');
            const file = e.target.files[0];
            if (file) {
                console.log('✅ 文件选择成功:', file.name);
                const success = handleFile(file);
                if (!success) {
                    // 如果文件处理失败，清空文件输入
                    e.target.value = '';
                    console.log('文件处理失败，已清空文件输入');
                }
            } else {
                console.log('没有选择文件');
                // 禁用上传按钮
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) {
                    uploadBtn.disabled = true;
                }
                // 隐藏预览
                const previewContainer = document.getElementById('previewContainer');
                if (previewContainer) {
                    previewContainer.style.display = 'none';
                }
            }
        });

        console.log('✅ 文件选择功能初始化完成');
    }

    console.log('所有事件监听器初始化完成');
});

// 测试函数已移除 - 使用原生HTML label标签实现

// 初始化拖拽功能
function initDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    if (!uploadArea || !fileInput) {
        console.error('Upload area or file input not found');
        return;
    }

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    // 防止页面级别的拖拽事件
    document.addEventListener('dragover', function(e) {
        e.preventDefault();
    });

    document.addEventListener('drop', function(e) {
        e.preventDefault();
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });

    uploadArea.addEventListener('drop', handleDrop, false);
    console.log('拖拽功能初始化完成');
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight(e) {
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.classList.add('dragover');
    }
}

function unhighlight(e) {
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.classList.remove('dragover');
    }
}

</script>
{% endblock %}