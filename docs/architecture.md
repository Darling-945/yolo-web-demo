# 系统架构

## 整体架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Frontend  │    │   Flask API     │    │  YOLO Inference │
│                 │    │                 │    │                 │
│  - HTML5/CSS3   │◄──►│  - File Upload  │◄──►│  - Ultralytics  │
│  - JavaScript   │    │  - API Routes   │    │  - Multi-format │
│  - Bootstrap    │    │  - Validation   │    │  - Detection    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │  File System    │
                       │                 │
                       │  - Uploads/     │
                       │  - Outputs/     │
                       │  - Models/      │
                       │  - Logs/        │
                       └─────────────────┘
```

## 核心组件

### 1. Flask Web应用 (`app.py`)
- **路由管理**: 处理Web页面和API请求
- **文件上传**: 安全的文件接收和验证
- **推理协调**: 管理YOLO推理流程
- **错误处理**: 统一的异常处理机制
- **速率限制**: API访问频率控制

### 2. YOLO推理引擎 (`model_inference.py`)
- **模型管理**: 支持多种YOLO模型格式
- **推理执行**: 高性能目标检测
- **结果处理**: 检测结果格式化和统计
- **格式支持**: PyTorch(.pt)、ONNX(.onnx)、TensorRT(.engine)

### 3. 工具模块 (`utils/utils.py`)
- **文件验证**: 多层级图片格式验证
- **安全处理**: 文件名安全化、路径验证
- **清理服务**: 自动文件清理和生命周期管理
- **配置管理**: 动态配置加载和验证

### 4. 模型转换器 (`convert_models.py`)
- **格式转换**: PyTorch到ONNX的模型转换
- **优化设置**: 模型简化和性能优化
- **批量处理**: 支持批量模型转换
- **转换日志**: 详细的转换过程记录

### 5. 配置系统 (`run.py`)
- **环境管理**: 开发/生产环境配置
- **参数验证**: 配置项合法性检查
- **文件生成**: 自动创建配置文件
- **启动管理**: 应用程序启动和生命周期

## 数据流

```
用户上传图片 → 文件验证 → 模型加载 → YOLO推理 → 结果处理 → 输出返回
     ↓              ↓         ↓         ↓         ↓         ↓
  前端界面      安全检查    模型缓存    目标检测    标注生成    结果展示
```

## 安全架构

### 1. 文件安全
- **类型验证**: 文件MIME类型和扩展名检查
- **大小限制**: 文件大小和维度限制
- **路径安全**: 防止路径遍历攻击
- **存储隔离**: 上传文件与应用代码隔离

### 2. API安全
- **速率限制**: 防止API滥用
- **输入验证**: 严格的参数验证
- **错误处理**: 安全的错误信息返回
- **日志记录**: 完整的安全事件日志

### 3. 系统安全
- **权限控制**: 最小权限原则
- **配置隔离**: 敏感配置环境变量化
- **自动清理**: 防止磁盘空间滥用
- **监控日志**: 系统运行状态监控

## 性能优化

### 1. 模型优化
- **模型缓存**: 避免重复加载
- **格式选择**: 根据硬件选择最优格式
- **推理优化**: 批处理和并行处理
- **内存管理**: 智能内存释放

### 2. 文件优化
- **异步清理**: 后台文件清理
- **压缩存储**: 结果文件压缩
- **缓存策略**: 常用文件缓存
- **生命周期**: 智能文件生命周期管理

### 3. 网络优化
- **连接池**: 数据库连接复用
- **响应压缩**: HTTP响应压缩
- **静态资源**: CDN和缓存策略
- **并发控制**: 合理的并发限制

## 扩展性设计

### 1. 模型扩展
- **插件机制**: 新模型格式支持
- **版本管理**: 多版本模型共存
- **热更新**: 模型热加载支持
- **A/B测试**: 模型效果对比

### 2. 功能扩展
- **微服务架构**: 服务拆分支持
- **消息队列**: 异步任务处理
- **容器化**: Docker部署支持
- **云原生**: Kubernetes部署

### 3. 监控扩展
- **指标收集**: Prometheus集成
- **日志聚合**: ELK Stack集成
- **链路追踪**: 分布式追踪
- **告警系统**: 智能告警机制

## 部署架构

### 1. 单机部署
```
┌─────────────────────────────────────┐
│            服务器节点                │
│  ┌─────────────┐  ┌─────────────┐  │
│  │  Nginx      │  │   Flask     │  │
│  │  反向代理    │  │   应用       │  │
│  └─────────────┘  └─────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  │
│  │   文件存储   │  │   日志系统   │  │
│  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────┘
```

### 2. 集群部署
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  负载均衡器   │◄──►│  应用节点1   │◄──►│  文件存储    │
│  (Nginx)    │    │  (Flask)    │    │  (NFS/S3)   │
└─────────────┘    └─────────────┘    └─────────────┘
                       │
                       ▼
              ┌─────────────┐
              │  数据库/缓存  │
              │ (Redis/SQL) │
              └─────────────┘
```

### 3. 容器部署
```yaml
version: '3.8'
services:
  web:
    image: yolo-web-demo:latest
    ports:
      - "5000:5000"
    volumes:
      - ./uploads:/app/uploads
      - ./models:/app/models
    environment:
      - FLASK_ENV=production

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
```